<div class="cloud-sync-page">
  <header class="page-header">
    <div class="header-content">
      <h1 class="page-title">Cloud-Synchronisation</h1>
      <p class="page-subtitle">Manuelle Synchronisation von Nodes und Messwerten zur Cloud</p>
    </div>
    <button mat-icon-button (click)="refresh()" matTooltip="Aktualisieren">
      <mat-icon>refresh</mat-icon>
    </button>
  </header>

  @if (isLoading()) {
    <myiotgrid-loading-spinner message="Lade Sync-Status..."></myiotgrid-loading-spinner>
  } @else {
    <!-- Summary Cards -->
    <div class="summary-grid">
      <mat-card class="summary-card">
        <mat-card-content>
          <div class="summary-value">{{ syncSummary()?.totalNodes || 0 }}</div>
          <div class="summary-label">Nodes Gesamt</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card synced">
        <mat-card-content>
          <div class="summary-value">{{ syncSummary()?.syncedNodes || 0 }}</div>
          <div class="summary-label">Synchronisiert</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card pending">
        <mat-card-content>
          <div class="summary-value">{{ syncSummary()?.neverSyncedNodes || 0 }}</div>
          <div class="summary-label">Nie Synchronisiert</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card readings">
        <mat-card-content>
          <div class="summary-value">{{ syncSummary()?.totalUnsyncedReadings || 0 }}</div>
          <div class="summary-label">Unsynced Readings</div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Active Syncs -->
    @if (hasActiveSyncs()) {
      <mat-card class="active-syncs-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="syncing">sync</mat-icon>
          <mat-card-title>Aktive Synchronisationen</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @for (sync of activeSyncsList(); track sync.nodeId) {
            <div class="active-sync-item">
              <div class="sync-info">
                <span class="node-name">{{ sync.nodeName }}</span>
                <span class="sync-stage">{{ sync.progress.stage }}: {{ sync.progress.message }}</span>
              </div>
              @if (sync.progress.percentComplete !== null && sync.progress.percentComplete !== undefined) {
                <mat-progress-bar
                  mode="determinate"
                  [value]="sync.progress.percentComplete"
                ></mat-progress-bar>
                <span class="progress-text">
                  {{ sync.progress.readingsSynced || 0 }} / {{ sync.progress.totalReadings || 0 }}
                  ({{ sync.progress.percentComplete }}%)
                </span>
              } @else {
                <mat-progress-bar mode="indeterminate"></mat-progress-bar>
              }
              <button mat-icon-button color="warn" (click)="cancelSync(sync.nodeId)" matTooltip="Abbrechen">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          }
        </mat-card-content>
      </mat-card>
    }

    <!-- Node List -->
    <mat-card class="nodes-card">
      <mat-card-header>
        <mat-icon mat-card-avatar>devices</mat-icon>
        <mat-card-title>Nodes</mat-card-title>
        <mat-card-subtitle>Status und manuelle Synchronisation</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        @if (syncStatusList().length === 0) {
          <div class="empty-state">
            <mat-icon>cloud_off</mat-icon>
            <p>Keine Nodes gefunden</p>
          </div>
        } @else {
          <mat-accordion>
            @for (status of syncStatusList(); track status.nodeId) {
              <mat-expansion-panel
                [expanded]="selectedNodeId() === status.nodeId"
                (opened)="loadHistory(status.nodeId)"
                (closed)="selectedNodeId() === status.nodeId && loadHistory(status.nodeId)"
              >
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <mat-icon class="node-icon">memory</mat-icon>
                    <span class="node-name">{{ status.nodeName }}</span>
                  </mat-panel-title>
                  <mat-panel-description>
                    <div class="node-status-badges">
                      @if (status.cloudId) {
                        <mat-chip color="primary" highlighted>
                          <mat-icon>cloud_done</mat-icon>
                          Verknüpft
                        </mat-chip>
                      } @else {
                        <mat-chip>
                          <mat-icon>cloud_off</mat-icon>
                          Nicht verknüpft
                        </mat-chip>
                      }
                      @if (status.unsyncedReadingsCount > 0) {
                        <mat-chip color="accent" highlighted>
                          {{ status.unsyncedReadingsCount }} unsynced
                        </mat-chip>
                      }
                      @if (isSyncing(status.nodeId)) {
                        <mat-chip color="warn" highlighted>
                          <mat-icon class="syncing">sync</mat-icon>
                          Synchronisiert...
                        </mat-chip>
                      }
                    </div>
                  </mat-panel-description>
                </mat-expansion-panel-header>

                <div class="node-details">
                  <div class="detail-row">
                    <span class="label">Letzter Sync:</span>
                    <span class="value">
                      @if (status.lastSyncAt) {
                        {{ status.lastSyncAt | relativeTime }}
                        @if (status.lastSyncSuccess) {
                          <mat-icon class="success">check_circle</mat-icon>
                        } @else {
                          <mat-icon class="error">error</mat-icon>
                        }
                      } @else {
                        Noch nie synchronisiert
                      }
                    </span>
                  </div>

                  @if (status.lastSyncError) {
                    <div class="detail-row error">
                      <span class="label">Letzter Fehler:</span>
                      <span class="value">{{ status.lastSyncError }}</span>
                    </div>
                  }

                  @if (status.lastSyncDuration) {
                    <div class="detail-row">
                      <span class="label">Dauer:</span>
                      <span class="value">{{ formatDuration(status.lastSyncDuration) }}</span>
                    </div>
                  }

                  <div class="detail-row">
                    <span class="label">Cloud ID:</span>
                    <span class="value cloud-id">{{ status.cloudId || '–' }}</span>
                  </div>

                  <div class="node-actions">
                    @if (isSyncing(status.nodeId)) {
                      <button mat-raised-button color="warn" (click)="cancelSync(status.nodeId)">
                        <mat-icon>close</mat-icon>
                        Abbrechen
                      </button>
                    } @else {
                      <button
                        mat-raised-button
                        color="primary"
                        (click)="startSync(status.nodeId)"
                        [disabled]="status.unsyncedReadingsCount === 0 && status.cloudId !== null"
                      >
                        <mat-icon>cloud_upload</mat-icon>
                        Jetzt synchronisieren
                      </button>
                    }
                  </div>

                  <!-- History Section -->
                  @if (selectedNodeId() === status.nodeId) {
                    <div class="history-section">
                      <h4>Sync-Historie</h4>
                      @if (isHistoryLoading()) {
                        <mat-spinner diameter="24"></mat-spinner>
                      } @else if (selectedNodeHistory().length === 0) {
                        <p class="no-history">Keine Sync-Historie vorhanden</p>
                      } @else {
                        <table mat-table [dataSource]="selectedNodeHistory()" class="history-table">
                          <ng-container matColumnDef="startedAt">
                            <th mat-header-cell *matHeaderCellDef>Zeitpunkt</th>
                            <td mat-cell *matCellDef="let entry">{{ entry.startedAt | relativeTime }}</td>
                          </ng-container>

                          <ng-container matColumnDef="nodeAction">
                            <th mat-header-cell *matHeaderCellDef>Aktion</th>
                            <td mat-cell *matCellDef="let entry">{{ entry.nodeAction }}</td>
                          </ng-container>

                          <ng-container matColumnDef="sensors">
                            <th mat-header-cell *matHeaderCellDef>Sensoren</th>
                            <td mat-cell *matCellDef="let entry">
                              +{{ entry.sensorsCreated }} / ~{{ entry.sensorsUpdated }}
                            </td>
                          </ng-container>

                          <ng-container matColumnDef="readings">
                            <th mat-header-cell *matHeaderCellDef>Readings</th>
                            <td mat-cell *matCellDef="let entry">{{ entry.readingsSynced }}</td>
                          </ng-container>

                          <ng-container matColumnDef="duration">
                            <th mat-header-cell *matHeaderCellDef>Dauer</th>
                            <td mat-cell *matCellDef="let entry">{{ formatDuration(entry.duration) }}</td>
                          </ng-container>

                          <ng-container matColumnDef="status">
                            <th mat-header-cell *matHeaderCellDef>Status</th>
                            <td mat-cell *matCellDef="let entry">
                              @if (entry.success) {
                                <mat-icon class="success">check_circle</mat-icon>
                              } @else {
                                <mat-icon class="error" [matTooltip]="entry.error || 'Fehler'">error</mat-icon>
                              }
                            </td>
                          </ng-container>

                          <tr mat-header-row *matHeaderRowDef="historyColumns"></tr>
                          <tr mat-row *matRowDef="let row; columns: historyColumns;"></tr>
                        </table>
                      }
                    </div>
                  }
                </div>
              </mat-expansion-panel>
            }
          </mat-accordion>
        }
      </mat-card-content>
    </mat-card>
  }
</div>
